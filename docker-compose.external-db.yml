# This docker-compose file is configured to use an external PostgreSQL database.
# Set the following environment variables before running:
#   POSTGRES_HOST, POSTGRES_PORT (default 5432), POSTGRES_DB,
#   POSTGRES_USER, POSTGRES_PASSWORD

version: "3.9"

services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  migrate:
    image: ${PRETALX_IMAGE:-ghcr.io/coscup/pretalx:latest}
    build:
      context: .
      args:
        PRETALX_VERSION: ${PRETALX_VERSION:-main}
        PRETALX_UID: ${PRETALX_UID:-1000}
        PRETALX_GID: ${PRETALX_GID:-1000}
    depends_on:
      redis:
        condition: service_healthy
    environment:
      POSTGRES_DB: ${POSTGRES_DB:?Please set POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER:?Please set POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Please set POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST:?Please set POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      REDIS_URL: redis://redis:6379/0
      REDIS_SESSIONS: redis://redis:6379/1
      CELERY_BACKEND: redis://redis:6379/2
      CELERY_BROKER: redis://redis:6379/3
      PRETALX_SITE_URL: ${PRETALX_SITE_URL:-http://localhost}
      PRETALX_SECRET_KEY: ${PRETALX_SECRET_KEY:?Please set PRETALX_SECRET_KEY}
      PRETALX_FILESYSTEM_MEDIA: ${PRETALX_FILESYSTEM_MEDIA:-/public/media}
      PRETALX_FILESYSTEM_STATIC: ${PRETALX_FILESYSTEM_STATIC:-/public/static}
      PRETALX_MAIL_FROM: ${PRETALX_MAIL_FROM:-pretalx@localhost}
      PRETALX_MAIL_HOST: ${PRETALX_MAIL_HOST:-localhost}
      PRETALX_MAIL_PORT: ${PRETALX_MAIL_PORT:-25}
      PRETALX_MAIL_USER: ${PRETALX_MAIL_USER:-}
      PRETALX_MAIL_PASSWORD: ${PRETALX_MAIL_PASSWORD:-}
      PRETALX_MAIL_TLS: ${PRETALX_MAIL_TLS:-False}
      PRETALX_MAIL_SSL: ${PRETALX_MAIL_SSL:-False}
    volumes:
      - pretalx_data:/data
      - pretalx_public:/public
    command: ["upgrade"]
    restart: "no"

  web:
    image: ${PRETALX_IMAGE:-ghcr.io/coscup/pretalx:latest}
    build:
      context: .
      args:
        PRETALX_VERSION: ${PRETALX_VERSION:-main}
        PRETALX_UID: ${PRETALX_UID:-1000}
        PRETALX_GID: ${PRETALX_GID:-1000}
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      POSTGRES_DB: ${POSTGRES_DB:?Please set POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER:?Please set POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Please set POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST:?Please set POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      REDIS_URL: redis://redis:6379/0
      REDIS_SESSIONS: redis://redis:6379/1
      CELERY_BACKEND: redis://redis:6379/2
      CELERY_BROKER: redis://redis:6379/3
      PRETALX_SITE_URL: ${PRETALX_SITE_URL:-http://localhost}
      PRETALX_SECRET_KEY: ${PRETALX_SECRET_KEY:?Please set PRETALX_SECRET_KEY}
      PRETALX_FILESYSTEM_MEDIA: ${PRETALX_FILESYSTEM_MEDIA:-/public/media}
      PRETALX_FILESYSTEM_STATIC: ${PRETALX_FILESYSTEM_STATIC:-/public/static}
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-4}
      GUNICORN_MAX_REQUESTS: ${GUNICORN_MAX_REQUESTS:-1200}
      GUNICORN_MAX_REQUESTS_JITTER: ${GUNICORN_MAX_REQUESTS_JITTER:-50}
      GUNICORN_FORWARDED_ALLOW_IPS: ${GUNICORN_FORWARDED_ALLOW_IPS:-*}
      PRETALX_MAIL_FROM: ${PRETALX_MAIL_FROM:-pretalx@localhost}
      PRETALX_MAIL_HOST: ${PRETALX_MAIL_HOST:-localhost}
      PRETALX_MAIL_PORT: ${PRETALX_MAIL_PORT:-25}
      PRETALX_MAIL_USER: ${PRETALX_MAIL_USER:-}
      PRETALX_MAIL_PASSWORD: ${PRETALX_MAIL_PASSWORD:-}
      PRETALX_MAIL_TLS: ${PRETALX_MAIL_TLS:-False}
      PRETALX_MAIL_SSL: ${PRETALX_MAIL_SSL:-False}
    volumes:
      - pretalx_data:/data
      - pretalx_public:/public
    ports:
      - "${PRETALX_PORT:-8080}:8000"
    command: ["web"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthcheck/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  worker:
    image: ${PRETALX_IMAGE:-ghcr.io/coscup/pretalx:latest}
    build:
      context: .
      args:
        PRETALX_VERSION: ${PRETALX_VERSION:-main}
        PRETALX_UID: ${PRETALX_UID:-1000}
        PRETALX_GID: ${PRETALX_GID:-1000}
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      POSTGRES_DB: ${POSTGRES_DB:?Please set POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER:?Please set POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Please set POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST:?Please set POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      REDIS_URL: redis://redis:6379/0
      REDIS_SESSIONS: redis://redis:6379/1
      CELERY_BACKEND: redis://redis:6379/2
      CELERY_BROKER: redis://redis:6379/3
      PRETALX_SITE_URL: ${PRETALX_SITE_URL:-http://localhost}
      PRETALX_SECRET_KEY: ${PRETALX_SECRET_KEY:?Please set PRETALX_SECRET_KEY}
      PRETALX_FILESYSTEM_MEDIA: ${PRETALX_FILESYSTEM_MEDIA:-/public/media}
      PRETALX_FILESYSTEM_STATIC: ${PRETALX_FILESYSTEM_STATIC:-/public/static}
      PRETALX_MAIL_FROM: ${PRETALX_MAIL_FROM:-pretalx@localhost}
      PRETALX_MAIL_HOST: ${PRETALX_MAIL_HOST:-localhost}
      PRETALX_MAIL_PORT: ${PRETALX_MAIL_PORT:-25}
      PRETALX_MAIL_USER: ${PRETALX_MAIL_USER:-}
      PRETALX_MAIL_PASSWORD: ${PRETALX_MAIL_PASSWORD:-}
      PRETALX_MAIL_TLS: ${PRETALX_MAIL_TLS:-False}
      PRETALX_MAIL_SSL: ${PRETALX_MAIL_SSL:-False}
    volumes:
      - pretalx_data:/data
      - pretalx_public:/public
    command: ["worker"]
    healthcheck:
      disable: true

volumes:
  redis_data:
  pretalx_data:
  pretalx_public:
